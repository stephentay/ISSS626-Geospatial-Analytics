---
title: "In-class Ex 3"
subtitle: ""
author: "Stephen Tay"
date: "9 Sep 2024"
date-modified:  "last-modified"
execute: 
  eval: true
  echo: true
  message: false
  warning: false
  freeze: true 
---


# 1. 
```{r}
pacman::p_load(sf, spNetwork, tmap, tidyverse)
```

# 2. Loading Data
```{r}
network <- st_read(dsn="data/geospatial", 
                   layer="Punggol_St")
```

# 2.2 Punggol Childcare Centers
Childcare point geometries are in 3-dimensional coordinates, they must be transformed to 2-dimensional coordinates using the `st_zm()` method.

```{r}
#| include: false
childcare <- st_read(dsn="data/geospatial", layer="Punggol_CC") %>%
  st_zm(drop = TRUE, what = "ZM")
```

```{r}
childcare
```

# 3. Plotting
Plot the road network first, followed by the points. `add = TRUE` adds the point layer on the road network.
```{r}
plot(st_geometry(network))
plot(childcare,add=T,col='red',pch = 19)
```

If you just `plot(network)`, it will plot every column in the network sf dataset, which is meaningless. Thus, the correct way is to use `plot(st_geometry(network))` as above.
```{r}
plot(network)
plot(childcare,add=T,col='red',pch = 19)
```
`tmap_mode('plot')` will just plot a static map.
Specify the layer to use using `tm_shape()`. 
tm_symbols() and tm_markers() when you want to customise the display of the points using png files.
Use `tm_square()`, `tm_bubbles()`, `tm_dots` for standard display of points. 
```{r}
tmap_mode('plot')
tm_shape(childcare) + 
  tm_dots(col = 'red') + 
  tm_shape(network) +
  tm_lines()
```


`tmap_mode('view')` will plot an interactive map.
```{r}
tmap_mode('view')
tm_shape(childcare) + 
  tm_dots() + 
  tm_shape(network) +
  tm_lines()
tmap_mode('plot')
```


# 4. Network Kernel Density Estimation (NKDE) Analysis

## 4.1 Prepare lixels
700m was chosen as the lixel length because it's based on a research on the walkable distance in Singapore environment. 
Minimum distance was arbitrarily set at 350m.
```{r}
lixels <- lixelize_lines(network, 
                         lx_length = 700, 
                         mindist = 350)
nrow(lixels)
```


```{r}
lixels <- lixelize_lines(network, 
                         lx_length = 700, 
                         mindist = 50)
nrow(lixels)
```

length of distance should not be shorter than the distance between data points. 
use nearest neighbor method and test out 10th, 25th percentile of the distance between points.
```{r}
lixels <- lixelize_lines(network, 
                         lx_length = 1000, 
                         mindist = 150)
nrow(lixels)
```


```{r}
samples <- lines_center(lixels) 
```


```{r}
tmap_mode('view')
tm_shape(lixels) + 
  tm_lines() + 
  tm_shape(samples) +
  tm_dots(size = 0.01)
tmap_mode('plot')
```


```{r}
simple_densities <- nkde(lines = network, events = childcare,
                  w = rep(1, nrow(childcare)), samples = samples,
                  kernel_name = "quartic", bw = 300, 
                  div= "bw", method = "simple", 
                  digits = 1, tol = 1,
                  grid_shape = c(1,1), max_depth = 8,
                  agg = 5, sparse = TRUE,
                  verbose = FALSE)
```

```{r}
# number per kilometer
samples$simple_density <- simple_densities*1000
lixels$simple_density <- simple_densities*1000
tmap_mode('view')
tm_shape(lixels) +
  tm_lines(col="simple_density") +
  tm_shape(childcare) +
  tm_dots()
tmap_mode('plot')
```

# 5. Network-constrained G- and K-function analysis
A test for complete spatial randomness (CSR) can be performed using the **network-constrained G- and K-functions**.

The test hypotheses are as follows:

-   H0: The distribution of childcare services in Punggol are randomly distributed along the road network.
-   H1: The distribution of childcare services in Punggol are not randomly distributed along the road network.

Alpha is set at 0.05, with 1000 Monte-carlo simulations.

```{r}
set.seed(2024)
kfun_childcare <- kfunctions(network, 
                             childcare,
                             start = 0, 
                             end = 1000, 
                             step = 50, 
                             width = 50, 
                             nsim = 1000, 
                             resolution = 50,
                             verbose = FALSE, 
                             conf_int = 0.05)
```

## 5.1 Network K-function
The blue line represents the empirical network K-function of the childcare centers in Punggol, while the gray area shows the results of 1,000 simulations within the 2.5% - 97.5% confidence interval. Since the blue line falls below the lower boundary of the envelope between the 200-400m distance range, it indicates a regular pattern of childcare center locations along the Punggol road network. The childcare centers are regularly spaced between 200-400m.
```{r}
kfun_childcare$plotk
```


```{r}
kfun_childcare$plotg
```

